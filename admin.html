<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Siena — Dashboard Admin</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS Dédié -->
    <link rel="stylesheet" href="admin.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <!-- MODAL D'AUTHENTIFICATION -->
    <div id="password-modal" class="modal-overlay">
        <div class="modal">
            <h4>Accès Sécurisé</h4>
            <div class="small">Entrez le mot de passe administrateur pour accéder au tableau de bord.</div>
            <form id="password-form">
                <input type="password" id="password-input" placeholder="Mot de passe" required>
                <div class="modal-actions">
                    <button type="submit" id="submit-password-btn" class="btn btn-primary">Valider</button>
                </div>
            </form>
            <p id="password-error" class="small" style="color: var(--danger-color); margin-top: 10px;"></p>
        </div>
    </div>

    <!-- MODAL DE CONFIRMATION DE RÉINITIALISATION -->
    <div id="confirm-reset-modal" class="modal-overlay hidden">
        <div class="modal">
            <h4>Réinitialiser les données ?</h4>
            <div class="small">Cette action est irréversible et supprimera tous les avis et statistiques.</div>
            <div class="modal-actions">
                <button id="cancel-reset-btn" class="btn">Annuler</button>
                <button id="confirm-reset-btn" class="btn btn-primary" style="background: var(--danger-color);">Oui, réinitialiser</button>
            </div>
        </div>
    </div>

    <!-- LAYOUT PRINCIPAL -->
    <div class="wrap hidden" id="main-layout">
        <header class="admin-header">
            <div class="brand">
                <div class="logo">S</div>
                <div>
                    <h1 id="page-title">Dashboard</h1>
                    <div class="small">Administration &amp; gestion des avis</div>
                </div>
            </div>

            <div class="controls">
                <div class="filters" id="global-period-filter-container">
                    <label for="global-period-select">Période :</label>
                    <select id="global-period-select">
                        <option value="all">Tout</option>
                        <option value="30days">30 derniers jours</option>
                        <option value="7days" selected>7 derniers jours</option>
                    </select>
                </div>
                <div id="feedback-controls" class="filters hidden">
                    <div id="feedback-status-tabs">
                        <button class="btn active" data-status="new">Nouveaux</button>
                        <button class="btn" data-status="read">Lus</button>
                        <button class="btn" data-status="archived">Archivés</button>
                    </div>
                     <input type="search" id="feedback-search-input" placeholder="Rechercher..." style="padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(34,34,34,0.1);">
                </div>
            </div>
        </header>

        <aside class="sidebar">
            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="overview">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                    <span class="nav-text">Vue d'ensemble</span>
                </button>
                <button class="nav-tab" data-tab="sif">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.29 15.29L7.41 14l-1.42 1.41L10 18.12l4.29-4.29-1.41-1.41L10.71 15.3c.39-.39.75-.82 1.07-1.3H16v-1.5h-3.88c-.22-.71-.52-1.38-.89-1.98l1.4-1.4c.39-.39.39-1.02 0-1.41a.996.996 0 00-1.41 0l-1.48 1.48C8.96 8.16 8.5 7.79 8.07 7.51L8.5 6.06a.996.996 0 000-1.41.996.996 0 00-1.41 0L6.06 5.71c-.75.25-1.44.64-2.06 1.15l-1.41-1.41-1.41 1.41 1.41 1.41C2.16 9.29 2 10.11 2 11c0 1.1.9 2 2 2h1v1H4c-1.1 0-2-.9-2-2 0-.52.1-1.02.28-1.47l.88.88C5.02 10.78 5 11.38 5 12c0 .83.34 1.57.88 2.12L7 15.21l.71.71c.38.38.89.65 1.45.79v1.54h1.5v-1.54c.56-.14 1.06-.41 1.45-.79l.71-.71.09-.09c-1.13-.67-2.02-1.66-2.56-2.82H8v-1.5h2.03c.1-.34.23-.67.38-.98L9 10.41l1.41-1.41 1.41 1.41c.18-.15.37-.29.57-.42L10.81 8.41 12.22 7l1.59 1.59c.19-.09.38-.17.58-.24l.42-1.59 1.5-.4-1.5.4-.42 1.59c-.2.07-.39.15-.58.24L12.22 10l-1.41 1.41 1.41 1.41c-.15.2-.29.4-.42.62H15V15h-1.5v-1.5h-1.07c-.54 1.16-1.43 2.15-2.56 2.82l-.17-.16z"/></svg>
                    <span class="nav-text">Synthèse SIF</span>
                </button>
                <button class="nav-tab" data-tab="stats-serveurs">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                    <span class="nav-text">Stats Serveurs</span>
                </button>
                <button class="nav-tab" data-tab="performance-menu">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>
                    <span class="nav-text">Performance Menu</span>
                </button>
                <button class="nav-tab" data-tab="synthese-client">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                    <span class="nav-text">Synthèse Client</span>
                </button>
                <button class="nav-tab" data-tab="feedback-interne">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22 5.72l-4.6-3.86-1.29 1.53 4.6 3.86L22 5.72zM7.88 3.39L6.6 1.86 2 5.71l1.29 1.53 4.59-3.85zM12.5 8H11v6l4.75 2.85.75-1.23-4-2.37V8zM12 4c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9zm0 16c-3.86 0-7-3.14-7-7s3.14-7 7-7 7 3.14 7 7-3.14 7-7 7z"/></svg>
                    <span class="nav-text">Feedback Interne</span>
                </button>
                <button class="nav-tab" data-tab="settings">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23-.09.49 0 .61.22l2-3.46c.12-.22-.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                    <span class="nav-text">Paramètres</span>
                </button>
            </nav>
        </aside>

        <section class="main">
            <!-- Contenu dynamique chargé ici par JS -->
            <div id="overview-tab" class="tab-content">
                <div class="metrics">
                    <div class="metric">
                        <div id="reviews-period-title" class="kicker">Avis (Total)</div>
                        <div id="reviews-period-stat" class="value">...</div>
                    </div>
                    <div class="metric">
                        <div class="kicker">Moyenne / jour</div>
                        <div id="avg-reviews-stat" class="value">...</div>
                    </div>
                    <div class="metric" id="unread-feedback-stat">
                        <div class="kicker">Feedbacks non lus</div>
                        <div id="unread-feedback-count" class="value">...</div>
                    </div>
                </div>
                <div class="card" style="margin-top: 18px;">
                     <h2 class="card-title">Tendance des Avis (14 derniers jours)</h2>
                     <div class="chart-container"><canvas id="reviews-trend-chart"></canvas></div>
                </div>
                 <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 18px; margin-top: 18px;">
                    <div class="card"><h2 class="card-title">Top Serveurs</h2><div id="top-servers-widget"><p>Chargement...</p></div></div>
                    <div class="card"><h2 class="card-title">Top Plats</h2><div id="top-dishes-widget"><p>Chargement...</p></div></div>
                    <div class="card"><h2 class="card-title">Qualité de Service</h2><div id="top-quality-widget"><p>Chargement...</p></div></div>
                    <div class="card" style="grid-column: 1 / -1;"><h2 class="card-title">Dernier Feedback Interne</h2><div id="latest-feedback-widget"><p>Chargement...</p></div></div>
                </div>
            </div>

            <div id="sif-tab" class="tab-content hidden" style="display: grid; gap: 18px;">
                <div class="card" id="sif-synthesis-card" style="position: relative;">
                    <h2 class="card-title">Synthèse de la Période</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                        <div id="sif-strengths"><h4>👍 POINTS FORTS</h4><ul></ul></div>
                        <div id="sif-weaknesses"><h4>👎 POINTS FAIBLES</h4><ul></ul></div>
                    </div>
                </div>
                <div class="card" id="sif-sentiment-card" style="position: relative;">
                    <h2 class="card-title">Tendance du Sentiment</h2>
                    <div class="chart-container"><canvas id="sif-sentiment-chart"></canvas></div>
                </div>
                <div class="card" id="sif-suggestions-card" style="position: relative;">
                    <h2 class="card-title">💡 Suggestions de l'IA</h2>
                    <div id="sif-suggestions-list"></div>
                </div>
                <div class="card" id="sif-categories-card" style="position: relative;">
                    <h2 class="card-title">Catégorisation des Feedbacks</h2>
                    <div class="chart-container" style="height: 250px;"><canvas id="sif-categories-chart"></canvas></div>
                </div>
            </div>

            <div id="stats-serveurs-tab" class="tab-content hidden" style="display: grid; grid-template-columns: 1fr 1fr; gap: 18px;">
                <div class="card">
                    <h2 class="card-title">Classement des Avis</h2>
                    <table id="ranking-table">
                        <thead><tr><th>#</th><th>Serveur</th><th style="text-align:center;">Tendance</th><th style="text-align:right;">Avis</th></tr></thead>
                        <tbody><tr><td colspan="4">Chargement...</td></tr></tbody>
                    </table>
                </div>
                <div class="card">
                    <h2 class="card-title">Répartition des avis</h2>
                    <div class="chart-container" style="height: 400px;"><canvas id="server-distribution-chart"></canvas></div>
                </div>
            </div>

            <div id="performance-menu-tab" class="tab-content hidden">
                 <div class="filters" style="margin-bottom: 18px;">
                    <div><label for="perf-period-filter">Période :</label><select id="perf-period-filter" class="btn"><option value="all">Tout</option><option value="30days">30 derniers jours</option><option value="7days">7 derniers jours</option></select></div>
                    <div><label for="perf-category-filter">Catégorie :</label><select id="perf-category-filter" class="btn"><option value="all">Toutes</option></select></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 18px;">
                    <div class="card"><h2 class="card-title">🚀 Top 10 Plats</h2><div class="chart-container" style="height: 400px;"><canvas id="top-10-chart"></canvas></div></div>
                    <div class="card"><h2 class="card-title">📉 Flop 10 Plats</h2><div id="flops-table-container" style="max-height: 400px; overflow-y: auto;"><p>Chargement...</p></div></div>
                    <div class="card"><h2 class="card-title">Performance par Catégorie</h2><div class="chart-container"><canvas id="category-pie-chart"></canvas></div></div>
                    <div class="card"><h2 class="card-title">Données Complètes</h2><div id="full-data-table-container" style="max-height: 350px; overflow-y: auto;"><p>Chargement...</p></div></div>
                </div>
            </div>

            <div id="synthese-client-tab" class="tab-content hidden" style="display: grid; grid-template-columns: 1fr 1fr; gap: 18px;">
                <div class="card"><h2 class="card-title">Qualités de Service Appréciées</h2><div class="chart-container"><canvas id="service-qualities-chart"></canvas></div></div>
                <div class="card"><h2 class="card-title">Points Forts de l'Atmosphère</h2><div class="chart-container"><canvas id="atmosphere-chart"></canvas></div></div>
            </div>

            <div id="feedback-interne-tab" class="tab-content hidden">
                <div id="feedback-list" class="feedback-list"></div>
            </div>

            <div id="settings-tab" class="tab-content hidden">
                <div class="settings-grid">
                    <div class="card" id="servers-section"><h2 class="card-title">Gérer les Serveurs</h2><ul id="servers-list" class="item-list"></ul><form id="add-server-form" class="add-form"><input type="hidden" id="editing-server-id"><input type="text" id="new-server-name" placeholder="Prénom du serveur" required><button type="submit" class="btn btn-primary">Ajouter</button></form></div>
                    <div class="card" id="flavors-section"><h2 class="card-title">Gérer les Plats (Saveurs)</h2><ul id="flavors-list" class="item-list"></ul><form id="add-flavor-form" class="add-form"><input type="hidden" id="editing-flavor-id"><input type="text" id="new-flavor-text" placeholder="Nom du plat" required><select id="new-flavor-category" required><option value="" disabled selected>Choisir une catégorie</option><option value="Antipasti & Crudo">Antipasti & Crudo</option><option value="Pâtes">Pâtes</option><option value="Viandes & Poissons">Viandes & Poissons</option><option value="Desserts">Desserts</option><option value="Pizze">Pizze</option></select><button type="submit" class="btn btn-primary">Ajouter</button></form></div>
                    <div class="card" id="export-section"><h2 class="card-title">Exporter les Données</h2><div id="export-options" style="margin: 20px 0;"><label style="display:block; margin-bottom:10px;"><input type="checkbox" id="export-check-ranking" value="ranking"> Classement des serveurs</label><label style="display:block; margin-bottom:10px;"><input type="checkbox" id="export-check-performance" value="performance"> Performance des plats</label><label style="display:block; margin-bottom:10px;"><input type="checkbox" id="export-check-feedback" value="feedback"> Feedbacks internes</label></div><button id="export-selected-btn" class="btn btn-primary">Lancer l'Exportation</button></div>
                    <div class="card danger-zone"><h2 class="card-title">Zone de Danger</h2><p class="small">Cette action réinitialisera toutes les statistiques.</p><button id="reset-data-btn" class="btn">Réinitialiser les Données</button></div>
                </div>
            </div>
        </section>
    </div>

    <script>
    // TOUT LE JAVASCRIPT DE L'ANCIEN admin.html EST INTÉGRÉ ICI
    // Les sélecteurs et la logique ont été adaptés à la nouvelle structure HTML.
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION & CONSTANTES ---
        const API_BASE_URL = 'https://siena-avis.onrender.com';
        let charts = { reviewsTrend: null, serverDistribution: null, top10: null, categoryPie: null, serviceQualities: null, atmosphere: null, sifSentiment: null, sifCategories: null };
        const pageTitles = { overview: "Vue d'ensemble", sif: "Synthèse Intelligente (SIF)", 'stats-serveurs': "Statistiques Serveurs", 'performance-menu': "Performance Menu", 'synthese-client': "Synthèse Client", 'feedback-interne': "Feedbacks Internes", settings: "Paramètres" };
        const dataForExport = { serverRanking: [], dishPerformance: [], allFeedbacks: [] };

        // --- SÉLECTEURS DOM ---
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const mainLayout = document.getElementById('main-layout');
        const tabs = document.querySelectorAll('.nav-tab[data-tab]');
        const tabContents = document.querySelectorAll('.tab-content');
        const pageTitleEl = document.getElementById('page-title');
        const globalPeriodSelect = document.getElementById('global-period-select');
        const globalPeriodContainer = document.getElementById('global-period-filter-container');
        const feedbackControls = document.getElementById('feedback-controls');
        
        // --- LOGIQUE D'AUTHENTIFICATION ---
        const token = sessionStorage.getItem('jwt_token');
        if (token) {
            passwordModal.classList.add('hidden');
            mainLayout.classList.remove('hidden');
            initializeDashboard();
        }

        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password-input').value;
            const submitBtn = document.getElementById('submit-password-btn');
            const passwordError = document.getElementById('password-error');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Vérification...';
            passwordError.textContent = '';
            try {
                const response = await fetch(`${API_BASE_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: password })
                });
                if (!response.ok) throw new Error("Mot de passe incorrect.");
                const data = await response.json();
                sessionStorage.setItem('jwt_token', data.access_token);
                passwordModal.classList.add('hidden');
                mainLayout.classList.remove('hidden');
                initializeDashboard();
            } catch (error) {
                passwordError.textContent = error.message;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Valider';
            }
        });

        async function fetchWithAuth(url, options = {}) {
            const token = sessionStorage.getItem('jwt_token');
            if (!token) { logout(); throw new Error("Session expirée."); }
            const headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
            if (options.body && typeof options.body !== 'string') {
                headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(options.body);
            }
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401 || response.status === 422) { logout(); throw new Error("Session expirée."); }
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({error: `Erreur serveur (${response.status})`}));
                throw new Error(errorData.error || `Erreur: ${response.statusText}`);
            }
            const contentType = response.headers.get("content-type");
            return contentType?.includes("application/json") ? response.json() : response.text();
        }

        function logout() {
            sessionStorage.removeItem('jwt_token');
            mainLayout.classList.add('hidden');
            passwordModal.classList.remove('hidden');
        }

        // --- INITIALISATION ---
        function initializeDashboard() {
            setupNavigation();
            const activeTab = document.querySelector('.nav-tab.active')?.dataset.tab || 'overview';
            switchTab(activeTab);
        }

        // --- NAVIGATION ---
        function setupNavigation() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            globalPeriodSelect.addEventListener('change', () => {
                const activeTab = document.querySelector('.nav-tab.active').dataset.tab;
                loadDataForTab(activeTab);
            });
            // Clic sur les widgets pour naviguer
            document.getElementById('overview-tab').addEventListener('click', (e) => {
                if (e.target.closest('#top-servers-widget')) switchTab('stats-serveurs');
                if (e.target.closest('#top-dishes-widget')) switchTab('performance-menu');
                if (e.target.closest('#top-quality-widget')) switchTab('synthese-client');
                if (e.target.closest('#latest-feedback-widget')) switchTab('feedback-interne');
            });
        }

        function switchTab(tabName) {
            tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
            tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `${tabName}-tab`));
            
            pageTitleEl.textContent = pageTitles[tabName] || "Dashboard";
            
            // Gérer la visibilité des filtres
            const showGlobalFilter = ['overview', 'stats-serveurs', 'sif'].includes(tabName);
            const showFeedbackFilter = tabName === 'feedback-interne';
            const showPerfFilter = tabName === 'performance-menu';
            
            globalPeriodContainer.classList.toggle('hidden', !showGlobalFilter);
            feedbackControls.classList.toggle('hidden', !showFeedbackFilter);
            document.querySelector('#performance-menu-tab .filters').classList.toggle('hidden', !showPerfFilter);

            loadDataForTab(tabName);
        }

        function loadDataForTab(tabName) {
            switch(tabName) {
                case 'overview': loadOverviewData(); break;
                case 'sif': loadSifData(); break;
                case 'stats-serveurs': loadServerStatsData(); break;
                case 'performance-menu': loadMenuPerformanceData(); break;
                case 'synthese-client': loadQualitativeSynthesisData(); break;
                case 'feedback-interne': loadInternalFeedbackData('new', document.getElementById('feedback-search-input').value.trim()); break;
                case 'settings': loadManagementData(); break;
            }
        }
        
        // --- CHARGEMENT DES DONNÉES & RENDU ---
        async function loadOverviewData() {
            const period = globalPeriodSelect.value;
            try {
                // Set loading state
                ['reviews-period-stat', 'avg-reviews-stat', 'unread-feedback-count'].forEach(id => document.getElementById(id).textContent = '...');
                const [overview, serverStats, menuPerf, qualSynth, unreadFeedbacks] = await Promise.all([
                    fetchWithAuth(`${API_BASE_URL}/dashboard?period=${period}`),
                    fetchWithAuth(`${API_BASE_URL}/api/server-stats?period=all`),
                    fetchWithAuth(`${API_BASE_URL}/api/menu-performance?period=all`),
                    fetchWithAuth(`${API_BASE_URL}/api/qualitative-synthesis`),
                    fetchWithAuth(`${API_BASE_URL}/api/internal-feedback?status=new`)
                ]);
                
                const periodTitleMap = { 'all': 'Avis (Total)', '30days': 'Avis (30 j.)', '7days': 'Avis (7 j.)' };
                document.getElementById('reviews-period-title').textContent = periodTitleMap[period];
                document.getElementById('reviews-period-stat').textContent = overview.stats.reviews_in_period;
                document.getElementById('avg-reviews-stat').textContent = overview.stats.average_reviews_per_day;
                document.getElementById('unread-feedback-count').innerHTML = `${unreadFeedbacks.length} <span class="notification-dot"></span>`;

                if (charts.reviewsTrend) charts.reviewsTrend.destroy();
                charts.reviewsTrend = new Chart(document.getElementById('reviews-trend-chart'), { type: 'line', data: { labels: overview.trend.map(d => new Date(d.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })), datasets: [{ label: 'Avis', data: overview.trend.map(d => d.count), borderColor: 'var(--brand-color)', backgroundColor: 'rgba(191, 91, 63, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } } });

                renderWidget(document.getElementById('top-servers-widget'), serverStats.slice(0, 3).map(s => `${s.server} (${s.count} avis)`));
                renderWidget(document.getElementById('top-dishes-widget'), menuPerf.slice(0, 3).map(d => `${d.dish_name} (${d.selection_count})`));
                renderWidget(document.getElementById('top-quality-widget'), qualSynth.service_qualities.slice(0, 3).map(q => `${q.value} (${q.count})`));
                const feedbackWidget = document.getElementById('latest-feedback-widget');
                if (unreadFeedbacks[0]) {
                    feedbackWidget.innerHTML = `<p class="small"><strong>De : ${unreadFeedbacks[0].server_name}</strong> - ${unreadFeedbacks[0].feedback_text.substring(0, 100)}...</p>`;
                } else {
                    feedbackWidget.innerHTML = `<p class="small">Aucun nouveau feedback.</p>`;
                }
            } catch (error) { 
                console.error("Erreur chargement Overview:", error);
                ['reviews-period-stat', 'avg-reviews-stat', 'unread-feedback-count'].forEach(id => document.getElementById(id).innerHTML = `<span class="small" style="color:red">Erreur</span>`);
            }
        }

        function renderWidget(container, items) {
            if (!items || items.length === 0) { container.innerHTML = '<p class="small">Pas de données.</p>'; return; }
            container.innerHTML = `<ul style="list-style:none; padding:0; margin:0; font-size: 14px; display:flex; flex-direction:column; gap:8px;">${items.map(i => `<li>${i}</li>`).join('')}</ul>`;
        }
        
        // ... (Le reste des fonctions JS de l'ancien fichier est ici, adapté)
        async function loadServerStatsData() {
            const period = globalPeriodSelect.value;
            try {
                const ranking = await fetchWithAuth(`${API_BASE_URL}/api/server-stats?period=${period}`);
                dataForExport.serverRanking = ranking;
                document.querySelector('#ranking-table tbody').innerHTML = ranking.length ? ranking.map((item, index) => `<tr><td>${index + 1}</td><td>${item.server}</td><td style="text-align:center;"><span class="trend-icon trend-stable">―</span></td><td style="text-align:right;">${item.count}</td></tr>`).join('') : '<tr><td colspan="4" style="text-align:center;">Aucun avis.</td></tr>';
                if (charts.serverDistribution) charts.serverDistribution.destroy();
                charts.serverDistribution = new Chart(document.getElementById('server-distribution-chart'), { type: 'doughnut', data: { labels: ranking.map(item => item.server), datasets: [{ data: ranking.map(item => item.count), backgroundColor: ['#BF5B3F', '#E7A977', '#FADCA5', '#A68A64', '#665A48'], borderColor: 'var(--card-bg)', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
            } catch (error) { document.querySelector('#ranking-table tbody').innerHTML = `<tr><td colspan="4" style="text-align:center;">${error.message}</td></tr>`; }
        }

        const performanceState = { allData: [] };
        document.getElementById('perf-period-filter').addEventListener('change', loadMenuPerformanceData);
        document.getElementById('perf-category-filter').addEventListener('change', renderPerformance);

        async function loadMenuPerformanceData() {
            const period = document.getElementById('perf-period-filter').value;
            try {
                const data = await fetchWithAuth(`${API_BASE_URL}/api/menu-performance?period=${period}`);
                performanceState.allData = data;
                const categories = [...new Set(data.map(item => item.dish_category))];
                document.getElementById('perf-category-filter').innerHTML = '<option value="all">Toutes</option>' + categories.sort().map(cat => `<option value="${cat}">${cat}</option>`).join('');
                renderPerformance();
            } catch (error) { console.error("Erreur chargement Performance:", error); }
        }

        function renderPerformance() {
            let filteredData = document.getElementById('perf-category-filter').value === 'all' ? performanceState.allData : performanceState.allData.filter(item => item.dish_category === document.getElementById('perf-category-filter').value);
            if (charts.top10) charts.top10.destroy();
            if (charts.categoryPie) charts.categoryPie.destroy();
            const top10Data = [...filteredData].sort((a, b) => b.selection_count - a.selection_count).slice(0, 10);
            charts.top10 = new Chart(document.getElementById('top-10-chart'), { type: 'bar', data: { labels: top10Data.map(d => d.dish_name), datasets: [{ label: 'Sélections', data: top10Data.map(d => d.selection_count), backgroundColor: 'rgba(191, 91, 63, 0.8)' }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            const flopsData = [...filteredData].sort((a, b) => a.selection_count - b.selection_count).slice(0, 10);
            let flopsTableHTML = '<table><thead><tr><th>Plat</th><th style="text-align:right;">Sélections</th></tr></thead><tbody>';
            flopsTableHTML += flopsData.length > 0 ? flopsData.map(item => `<tr><td>${item.dish_name}</td><td style="text-align:right;">${item.selection_count}</td></tr>`).join('') : '<tr><td colspan="2" style="text-align:center;">Données insuffisantes.</td></tr>';
            document.getElementById('flops-table-container').innerHTML = flopsTableHTML + '</tbody></table>';
            const categoryCounts = filteredData.reduce((acc, item) => { acc[item.dish_category] = (acc[item.dish_category] || 0) + item.selection_count; return acc; }, {});
            charts.categoryPie = new Chart(document.getElementById('category-pie-chart'), { type: 'pie', data: { labels: Object.keys(categoryCounts), datasets: [{ data: Object.values(categoryCounts), backgroundColor: ['#BF5B3F', '#E7A977', '#FADCA5', '#A68A64', '#665A48', '#9E6B55'], borderColor: 'var(--card-bg)', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });
            dataForExport.dishPerformance = [...filteredData].sort((a, b) => b.selection_count - a.selection_count);
            let tableHTML = '<table><thead><tr><th>Plat</th><th>Catégorie</th><th style="text-align:right;">Sélections</th></tr></thead><tbody>';
            tableHTML += dataForExport.dishPerformance.map(item => `<tr><td>${item.dish_name}</td><td>${item.dish_category}</td><td style="text-align:right;">${item.selection_count}</td></tr>`).join('');
            document.getElementById('full-data-table-container').innerHTML = tableHTML + '</tbody></table>';
        }

        async function loadQualitativeSynthesisData() {
            try {
                const data = await fetchWithAuth(`${API_BASE_URL}/api/qualitative-synthesis`);
                const createChart = (canvasId, chartVar, chartData) => {
                    const ctx = document.getElementById(canvasId);
                    if (charts[chartVar]) charts[chartVar].destroy();
                    if(chartData.length > 0) { charts[chartVar] = new Chart(ctx, { type: 'bar', data: { labels: chartData.map(item => item.value), datasets: [{ data: chartData.map(item => item.count), backgroundColor: 'rgba(191, 91, 63, 0.8)' }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } } }); } else { ctx.parentElement.innerHTML = '<p class="small">Pas de données.</p>'; }
                };
                createChart('service-qualities-chart', 'serviceQualities', data.service_qualities || []);
                createChart('atmosphere-chart', 'atmosphere', data.atmosphere || []);
            } catch (error) { console.error("Erreur Synthèse Client:", error); }
        }
        
        const feedbackState = { currentStatus: 'new' };
        const feedbackTabsContainer = document.getElementById('feedback-status-tabs');
        const feedbackListContainer = document.getElementById('feedback-list');
        const feedbackSearchInput = document.getElementById('feedback-search-input');
        feedbackSearchInput.addEventListener('input', () => loadInternalFeedbackData(feedbackState.currentStatus, feedbackSearchInput.value.trim()));
        feedbackTabsContainer.addEventListener('click', (e) => { if (e.target.dataset.status) { loadInternalFeedbackData(e.target.dataset.status, feedbackSearchInput.value.trim()); } });
        feedbackListContainer.addEventListener('click', async (e) => { if (e.target.dataset.action) { const card = e.target.closest('.feedback-card'); const id = card.dataset.id; const action = e.target.dataset.action; const newStatus = { read: 'read', archive: 'archived', new: 'new' }[action]; try { await fetchWithAuth(`${API_BASE_URL}/api/internal-feedback/${id}/status`, { method: 'PUT', body: { status: newStatus } }); loadInternalFeedbackData(feedbackState.currentStatus, feedbackSearchInput.value.trim()); if (document.querySelector('.nav-tab.active').dataset.tab === 'overview') { loadOverviewData(); } } catch (error) { alert(`Erreur: ${error.message}`); } } });

        async function loadInternalFeedbackData(status, searchTerm = '') {
            feedbackState.currentStatus = status;
            feedbackListContainer.innerHTML = '<p>Chargement...</p>';
            feedbackTabsContainer.querySelectorAll('button').forEach(t => t.classList.toggle('active', t.dataset.status === status));
            const url = new URL(`${API_BASE_URL}/api/internal-feedback`);
            url.searchParams.append('status', status);
            if (searchTerm) url.searchParams.append('search', searchTerm);
            try {
                const feedbacks = await fetchWithAuth(url.toString());
                dataForExport.allFeedbacks = feedbacks;
                feedbackListContainer.innerHTML = feedbacks.length === 0 ? '<p class="small" style="text-align:center; padding: 20px;">Aucun feedback.</p>' : feedbacks.map(fb => { const formattedDate = new Date(fb.created_at).toLocaleString('fr-FR'); let actionsHTML = ''; if (fb.status === 'new') actionsHTML = `<button data-action="read">Marquer lu</button>`; if (fb.status === 'read') actionsHTML = `<button data-action="archive">Archiver</button>`; if (fb.status === 'archived') actionsHTML = `<button data-action="new">Réactiver</button>`; let feedbackText = fb.feedback_text.replace(/</g, "&lt;").replace(/>/g, "&gt;"); if (searchTerm) { const regex = new RegExp(`(${searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi'); feedbackText = feedbackText.replace(regex, '<mark>$1</mark>'); } return `<div class="feedback-card" data-id="${fb.id}" data-status="${fb.status}"><div class="feedback-header"><span><strong>${fb.server_name}</strong></span><span class="small">${formattedDate}</span></div><p class="small">${feedbackText}</p><div class="feedback-actions">${actionsHTML}</div></div>`; }).join('');
            } catch (error) { feedbackListContainer.innerHTML = `<p class="small" style="text-align:center; padding: 20px; color:red;">${error.message}</p>`; }
        }

        const manage = { servers: { list: document.getElementById('servers-list'), form: document.getElementById('add-server-form'), idInput: document.getElementById('editing-server-id'), nameInput: document.getElementById('new-server-name'), btn: document.querySelector('#add-server-form button') }, flavors: { list: document.getElementById('flavors-list'), form: document.getElementById('add-flavor-form'), idInput: document.getElementById('editing-flavor-id'), textInput: document.getElementById('new-flavor-text'), catInput: document.getElementById('new-flavor-category'), btn: document.querySelector('#add-flavor-form button') } };
        async function loadManagementData() { try { const [servers, flavors] = await Promise.all([ fetchWithAuth(`${API_BASE_URL}/api/servers`), fetchWithAuth(`${API_BASE_URL}/api/options/flavors`) ]); populateManageList(manage.servers.list, servers.sort((a,b) => a.name.localeCompare(b.name)), 'servers'); populateManageList(manage.flavors.list, flavors.sort((a,b) => a.category.localeCompare(b.category) || a.text.localeCompare(b.text)), 'flavors'); } catch (error) { console.error("Erreur Gestion:", error); } }
        function populateManageList(listEl, items, type) { listEl.innerHTML = items.length === 0 ? '<li>Aucun élément.</li>' : items.map(item => { const text = item.name || item.text; const category = item.category ? ` <em class="small">(${item.category})</em>` : ''; return `<li><span>${text}${category}</span><div class="item-actions"><button class="action-btn edit-btn" data-id="${item.id}" data-type="${type}" data-name="${item.name || ''}" data-text="${item.text || ''}" data-category="${item.category || ''}" title="Éditer">✎</button><button class="action-btn delete-btn" data-id="${item.id}" data-type="${type}" title="Supprimer">×</button></div></li>`; }).join(''); }
        function resetServerForm() { manage.servers.form.reset(); manage.servers.idInput.value = ''; manage.servers.btn.textContent = 'Ajouter'; manage.servers.btn.classList.remove('edit-mode'); }
        function resetFlavorForm() { manage.flavors.form.reset(); manage.flavors.idInput.value = ''; manage.flavors.btn.textContent = 'Ajouter'; manage.flavors.btn.classList.remove('edit-mode'); }
        manage.servers.form.addEventListener('submit', async (e) => { e.preventDefault(); const id = manage.servers.idInput.value; const name = manage.servers.nameInput.value.trim(); if (!name) return; const url = id ? `${API_BASE_URL}/api/servers/${id}` : `${API_BASE_URL}/api/servers`; const method = id ? 'PUT' : 'POST'; await fetchWithAuth(url, { method, body: { name } }); resetServerForm(); loadManagementData(); });
        manage.flavors.form.addEventListener('submit', async (e) => { e.preventDefault(); const id = manage.flavors.idInput.value; const text = manage.flavors.textInput.value.trim(); const category = manage.flavors.catInput.value; if (!text || !category) return; const url = id ? `${API_BASE_URL}/api/options/flavors/${id}` : `${API_BASE_URL}/api/options/flavors`; const method = id ? 'PUT' : 'POST'; await fetchWithAuth(url, { method, body: { text, category } }); resetFlavorForm(); loadManagementData(); });
        document.getElementById('settings-tab').addEventListener('click', async (e) => { const target = e.target.closest('.action-btn'); if (!target) return; const { id, type } = target.dataset; if (target.classList.contains('delete-btn')) { const endpoint = type === 'servers' ? `/api/servers/${id}` : `/api/options/flavors/${id}`; if (confirm('Êtes-vous sûr ?')) { await fetchWithAuth(`${API_BASE_URL}${endpoint}`, { method: 'DELETE' }); loadManagementData(); } } else if (target.classList.contains('edit-btn')) { if (type === 'servers') { resetFlavorForm(); manage.servers.idInput.value = id; manage.servers.nameInput.value = target.dataset.name; manage.servers.btn.textContent = 'Enregistrer'; manage.servers.btn.classList.add('edit-mode'); manage.servers.nameInput.focus(); } else if (type === 'flavors') { resetServerForm(); manage.flavors.idInput.value = id; manage.flavors.textInput.value = target.dataset.text; manage.flavors.catInput.value = target.dataset.category; manage.flavors.btn.textContent = 'Enregistrer'; manage.flavors.btn.classList.add('edit-mode'); manage.flavors.textInput.focus(); } } });
        const confirmResetModal = document.getElementById('confirm-reset-modal');
        document.getElementById('reset-data-btn').addEventListener('click', () => confirmResetModal.classList.remove('hidden'));
        document.getElementById('cancel-reset-btn').addEventListener('click', () => confirmResetModal.classList.add('hidden'));
        document.getElementById('confirm-reset-btn').addEventListener('click', async () => { try { await fetchWithAuth(`${API_BASE_URL}/api/reset-data`, { method: 'POST' }); alert('Données réinitialisées.'); location.reload(); } catch (error) { alert(`Erreur: ${error.message}`); } finally { confirmResetModal.classList.add('hidden'); } });
        document.getElementById('export-selected-btn').addEventListener('click', () => {
            const date = new Date().toLocaleDateString('fr-CA'); let exportedCount = 0;
            function downloadCSV(data, filename) { if (!data || data.length === 0) { alert("Aucune donnée pour " + filename); return; } const headers = Object.keys(data[0]); const csvRows = ['\uFEFF' + headers.join(','), ...data.map(row => headers.map(fieldName => JSON.stringify(row[fieldName] ?? '')).join(','))]; const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename; link.click(); exportedCount++;}
            if (document.getElementById('export-check-ranking').checked) downloadCSV(dataForExport.serverRanking, `classement-serveurs-${date}.csv`);
            if (document.getElementById('export-check-performance').checked) downloadCSV(dataForExport.dishPerformance, `performance-plats-${date}.csv`);
            if (document.getElementById('export-check-feedback').checked) downloadCSV(dataForExport.allFeedbacks, `feedbacks-internes-${date}.csv`);
            if (exportedCount === 0) alert("Veuillez cocher au moins une case.");
        });

        // --- SIF LOGIC ---
        function showLoader(cardId) {
            const card = document.getElementById(cardId);
            if (!card.querySelector('.loader-overlay')) {
                card.insertAdjacentHTML('beforeend', '<div class="loader-overlay" style="position: absolute; inset: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; border-radius: 12px;"><div style="width: 30px; height: 30px; border: 3px solid #eee; border-top-color: var(--brand-color); border-radius: 50%; animation: spin 1s linear infinite;"></div></div>');
            }
        }
        function hideLoader(cardId) {
            const loader = document.querySelector(`#${cardId} .loader-overlay`);
            if (loader) loader.remove();
        }
        async function loadSifData() {
            const period = globalPeriodSelect.value;
            const cardIds = ['sif-synthesis-card', 'sif-sentiment-card', 'sif-suggestions-card', 'sif-categories-card'];
            cardIds.forEach(showLoader);
            try {
                const data = await fetchWithAuth(`${API_BASE_URL}/api/sif-synthesis?period=${period}`);
                renderSifSynthesis(data.strengths, data.weaknesses);
                renderSifSuggestions(data.suggestions);
                renderSifSentimentChart(data.sentiment_trend);
                renderSifCategoriesChart(data.categories);
            } catch (error) {
                console.error("Erreur SIF:", error);
                document.querySelector('#sif-strengths ul').innerHTML = `<li>Erreur: ${error.message}</li>`;
            } finally {
                cardIds.forEach(hideLoader);
            }
        }
        function renderSifSynthesis(strengths, weaknesses) {
            const renderList = (container, items) => { container.innerHTML = (items && items.length) ? items.map(item => `<li>${item}</li>`).join('') : '<li class="small">Aucune donnée.</li>'; };
            renderList(document.querySelector('#sif-strengths ul'), strengths);
            renderList(document.querySelector('#sif-weaknesses ul'), weaknesses);
        }
        function renderSifSuggestions(suggestions) {
            const container = document.getElementById('sif-suggestions-list');
            container.innerHTML = (!suggestions || !suggestions.length) ? '<p class="small">Aucune suggestion.</p>' : suggestions.map(item => `<div style="margin-bottom:12px;"><div class="small" style="font-weight:bold; color:var(--brand-color);">${item.category}</div><p class="small">${item.suggestion}</p></div>`).join('');
        }
        function renderSifSentimentChart(trendData) {
            const ctx = document.getElementById('sif-sentiment-chart');
            if (charts.sifSentiment) charts.sifSentiment.destroy();
            if (!trendData || trendData.length === 0) { ctx.parentElement.innerHTML = '<p class="small">Pas de données.</p>'; return; }
            charts.sifSentiment = new Chart(ctx, { type: 'line', data: { labels: trendData.map(d => new Date(d.date).toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'})), datasets: [{ data: trendData.map(d => d.score), borderColor: 'var(--brand-color)', backgroundColor: 'rgba(191, 91, 63, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: -100, max: 100 } }, plugins: { legend: { display: false } } } });
        }
        function renderSifCategoriesChart(categoryData) {
            const ctx = document.getElementById('sif-categories-chart');
            if (charts.sifCategories) charts.sifCategories.destroy();
            if (!categoryData || categoryData.length === 0) { ctx.parentElement.innerHTML = '<p class="small">Pas de données.</p>'; return; }
            charts.sifCategories = new Chart(ctx, { type: 'bar', data: { labels: categoryData.map(c => c.name), datasets: [{ data: categoryData.map(c => c.score), backgroundColor: ['rgba(191, 91, 63, 0.7)', 'rgba(231, 169, 119, 0.7)', 'rgba(166, 138, 100, 0.7)', 'rgba(102, 90, 72, 0.7)'] }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { min: 0, max: 100 } }, plugins: { legend: { display: false } } } });
        }
    });
    </script>
</body>
</html>

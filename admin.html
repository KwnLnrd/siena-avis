<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Le token CSRF est nécessaire pour les requêtes AJAX (POST, DELETE, etc.) -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Dashboard Sécurisé - Siena</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Styles CSS inchangés... */
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Montserrat:wght@400;500;600&display=swap');
        :root {
            --brand-color: #BF5B3F;
            --background-color: #FDFBF5;
            --surface-color: #FFFFFF;
            --text-primary: #2C2C2C;
            --text-secondary: #737373;
            --border-color: #EAE0D5;
            --font-serif: 'Cormorant Garamond', serif;
            --font-sans: 'Montserrat', sans-serif;
        }
        body{font-family:var(--font-sans);background-color:var(--background-color);color:var(--text-primary);margin:0;padding:20px;}
        .main-container{max-width:1200px;margin:0 auto;}
        .hidden{display:none!important}
        .header{display:flex;justify-content:space-between;align-items:center;padding-bottom:20px;border-bottom:1px solid var(--border-color);margin-bottom:20px}
        .header h1{font-family:var(--font-serif);font-size:2.5rem;margin:0}
        .header a { text-decoration: none; background-color: #F7F1E9; color: var(--text-primary); padding: 10px 18px; border-radius: 8px; font-weight: 500; }
        .nav-tabs{display:flex;gap:10px;margin-bottom:30px;border-bottom:1px solid var(--border-color)}
        .nav-tab{padding:12px 22px;cursor:pointer;border:none;background:0 0;font-size:1rem;font-weight:500;color:var(--text-secondary);border-bottom:3px solid transparent;transition:all .2s}
        .nav-tab.active{color:var(--brand-color);border-bottom-color:var(--brand-color)}
        .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:30px}
        .card{background-color:var(--surface-color);padding:25px;border-radius:12px;box-shadow:0 4px 20px -5px rgba(133,93,67,.1)}
        .card-full{grid-column:1/-1}
        .card-title{font-family:var(--font-serif);font-size:1.8rem;margin-top:0;margin-bottom:20px;color:var(--brand-color)}
        table{width:100%;border-collapse:collapse;text-align:left}
        th,td{padding:12px 15px;border-bottom:1px solid var(--border-color)}
        th{font-weight:600;cursor:pointer}
    </style>
</head>
<body>
    <div class="main-container" id="main-content">
        <header class="header">
            <h1>Tableau de Bord Siena</h1>
            <a href="{{ url_for('logout') }}">Se déconnecter</a>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="overview">Vue d'ensemble</button>
            <button class="nav-tab" data-tab="performance">Performance Menu</button>
            <button class="nav-tab" data-tab="feedback">Feedback Interne</button>
            <button class="nav-tab" data-tab="manage">Gestion</button>
        </nav>

        <main>
            <!-- Les conteneurs pour les onglets restent les mêmes -->
            <div id="overview-tab" class="tab-content">...</div>
            <div id="performance-tab" class="tab-content hidden">...</div>
            <div id="feedback-tab" class="tab-content hidden">...</div>
            <div id="manage-tab" class="tab-content hidden">...</div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = '/api'; // Les appels se font maintenant sur le même domaine
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // --- NOUVELLE FONCTION FETCH SÉCURISÉE ---
        async function fetchApi(url, options = {}) {
            // Ajoute automatiquement le token CSRF aux requêtes qui modifient des données
            const headers = { ...options.headers };
            if (options.method && options.method.toUpperCase() !== 'GET') {
                headers['X-CSRFToken'] = csrfToken;
                headers['Content-Type'] = 'application/json';
            }

            const response = await fetch(url, { ...options, headers });
            
            if (response.status === 401) { // Non autorisé
                window.location.href = '/login'; // Redirige si la session a expiré
                throw new Error("Session expirée.");
            }
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Erreur du serveur (${response.status})`);
            }
            return response.json();
        }

        // Le reste de votre logique JavaScript reste très similaire,
        // mais utilise `fetchApi` au lieu de `fetchWithAuth`.
        // Par exemple, pour charger les données de gestion :

        async function loadManagementData() {
            try {
                const [servers, flavors] = await Promise.all([
                    fetchApi(`${API_BASE_URL}/servers`),
                    fetchApi(`${API_BASE_URL}/options/flavors`)
                ]);
                // ... la suite de la fonction pour peupler les listes ...
            } catch (error) {
                console.error("Erreur chargement Gestion:", error);
            }
        }
        
        // Exemple pour une requête POST (Ajouter un serveur)
        manageElements.servers.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = manageElements.servers.input.value.trim();
            if (!name) return;
            try {
                await fetchApi(`${API_BASE_URL}/servers`, {
                    method: 'POST',
                    body: JSON.stringify({ name: name })
                });
                manageElements.servers.input.value = '';
                loadManagementData();
            } catch(error) {
                alert(`Erreur: ${error.message}`);
            }
        });
        
        // Initialisez le premier onglet
        loadDataForTab('overview'); 
    });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Unifié - Siena</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Montserrat:wght@400;500;600&display=swap');
        :root {
            --brand-color: #BF5B3F; --background-color: #FDFBF5; --surface-color: #FFFFFF;
            --text-primary: #2C2C2C; --text-secondary: #737373; --border-color: #EAE0D5;
            --font-serif: 'Cormorant Garamond', serif; --font-sans: 'Montserrat', sans-serif;
            --danger-color: #D32F2F; --edit-color: #1976D2; --success-color: #2E7D32; --ai-color: #6A1B9A;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        body { font-family: var(--font-sans); background-color: var(--background-color); color: var(--text-primary); margin: 0; padding: 20px; -webkit-font-smoothing: antialiased; }
        .main-container { max-width: 1400px; margin: 0 auto; animation: fadeIn .8s ease-out; }
        .hidden { display: none !important; }

        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);display:flex;justify-content:center;align-items:center;z-index:1000;backdrop-filter:blur(5px); padding: 15px;}
        .modal-content{background:var(--surface-color);padding:40px;border-radius:16px;box-shadow:0 10px 50px rgba(0,0,0,.2);text-align:center;width:100%;max-width:400px; box-sizing: border-box;}
        .modal-content h2{font-family:var(--font-serif);font-size:1.8rem;margin-top:0;margin-bottom:15px}
        .modal-content p{margin-bottom:25px;color:var(--text-secondary)}
        #password-form input{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:1rem;box-sizing:border-box;margin-bottom:15px}
        #password-form button{background-color:var(--brand-color);color:#fff;border:none;padding:14px;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;width:100%;transition:background-color .2s}
        #password-form button:disabled{background-color:var(--text-secondary);cursor:wait}
        .error-message{color:var(--danger-color);font-size:.9rem;margin-top:10px;min-height:1.2em}
        .modal-buttons { display: flex; gap: 15px; justify-content: center; }
        .modal-buttons button { padding: 12px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; border: 1px solid var(--border-color); }
        .modal-buttons .confirm-btn { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
        .modal-buttons .cancel-btn { background-color: var(--surface-color); color: var(--text-primary); }

        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}
        .header .logo-link img { width: 160px; }
        .header h1 { font-family: var(--font-serif); font-size: 2.5rem; margin: 0; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; }
        .nav-tab { padding: 12px 22px; cursor: pointer; border: none; background: none; font-size: 1rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.2s; text-align: center;}
        .nav-tab:hover { color: var(--text-primary); }
        .nav-tab.active { color: var(--brand-color); border-bottom-color: var(--brand-color); }
        /* NOUVEAU: Style pour l'onglet IA */
        .nav-tab[data-tab="ai-synthesis"].active { color: var(--ai-color); border-bottom-color: var(--ai-color); }

        .tab-content { animation: fadeIn .5s ease-out; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; }
        .card { background-color: var(--surface-color); padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px -5px rgba(133, 93, 67, .1); }
        .card-full { grid-column: 1 / -1; }
        .card-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .card-header .card-title { margin-bottom: 0; }
        .card-title { font-family: var(--font-serif); font-size: 1.8rem; margin-top: 0; margin-bottom: 20px; color: var(--brand-color); }
        .export-btn { background-color: var(--brand-color); color: var(--surface-color); border: 1px solid var(--brand-color); padding: 12px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 1rem; white-space: nowrap; }
        .export-btn:hover { background-color: #A64B35; }
        .export-btn:disabled { background-color: var(--text-secondary); cursor: not-allowed; }
        
        /* NOUVEAU: Style pour la carte de synthèse IA */
        .ai-card { border-left: 5px solid var(--ai-color); }
        .ai-card .card-title { color: var(--ai-color); }
        .ai-synthesis-content ul { list-style-type: '✨'; padding-left: 20px; }
        .ai-synthesis-content li { margin-bottom: 12px; line-height: 1.6; }

        table { width: 100%; border-collapse: collapse; text-align: left; }
        th, td { padding: 12px 15px; border-bottom: 1px solid var(--border-color); }
        th { font-weight: 600; cursor: pointer; }
        th:hover { color: var(--brand-color); }
        mark { background-color: #FADCA5; padding: 2px; border-radius: 3px; }
        .chart-container { position: relative; height: 350px; width: 100%; }

        .feedback-list { display: grid; gap: 20px; }
        .feedback-card { background-color: var(--surface-color); border: 1px solid var(--border-color); border-left-width: 5px; border-radius: 8px; padding: 20px; }
        .feedback-card[data-status="new"] { border-left-color: #1565C0; }
        .feedback-card[data-status="read"] { border-left-color: #757575; }
        .feedback-card[data-status="archived"] { border-left-color: #FFB74D; opacity: 0.8; }
        .feedback-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.9rem; flex-wrap: wrap; gap: 10px;}
        .feedback-actions button { border: 1px solid var(--border-color); background-color: #fff; color: var(--text-primary); padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; }

        .item-list { list-style: none; padding: 0; margin: 0; }
        .item-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; border-bottom: 1px solid var(--border-color); gap: 10px; }
        .item-list li span { flex-grow: 1; word-break: break-word; }
        .item-actions { display: flex; gap: 8px; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; transition: transform 0.2s; }
        .action-btn:hover { transform: scale(1.2); }
        .delete-btn { color: var(--danger-color); }
        .edit-btn { color: var(--edit-color); }
        .add-form { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .add-form input, .add-form select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .add-form button { background-color: var(--brand-color); color: #fff; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .add-form button.edit-mode { background-color: var(--edit-color); }
        .danger-zone { border: 2px solid var(--danger-color); margin-top: 30px; }
        .danger-zone .card-title { color: var(--danger-color); }
        .danger-zone button { background-color: var(--danger-color); }
        .export-option input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--brand-color); }
        .export-option label { display: flex; align-items: center; gap: 10px; font-size: 1.1rem; cursor: pointer; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { flex-direction: column; align-items: flex-start; gap: 20px; }
            .header h1 { font-size: 2rem; }
            .dashboard-grid { grid-template-columns: 1fr; gap: 20px; }
            .card { padding: 20px; }
            .nav-tab { padding: 10px 15px; font-size: 0.9rem; }
        }
        @media (max-width: 480px) {
            .modal-content { padding: 25px; }
            .nav-tabs { justify-content: center; }
            .nav-tab { flex-grow: 1; }
        }
    </style>
</head>
<body>

    <div id="password-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Accès Sécurisé</h2>
            <p>Veuillez entrer le mot de passe pour accéder au tableau de bord.</p>
            <form id="password-form">
                <input type="password" id="password-input" placeholder="Mot de passe" required>
                <button type="submit" id="submit-password-btn">Valider</button>
            </form>
            <p id="password-error" class="error-message"></p>
        </div>
    </div>

    <div id="confirm-reset-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 style="color: var(--danger-color);">Êtes-vous sûr ?</h2>
            <p>Cette action est irréversible. Toutes les données de classement, de performance et de synthèse seront définitivement supprimées.</p>
            <div class="modal-buttons">
                <button id="cancel-reset-btn" class="cancel-btn">Annuler</button>
                <button id="confirm-reset-btn" class="confirm-btn">Oui, réinitialiser</button>
            </div>
        </div>
    </div>

    <div class="main-container hidden" id="main-content">
        <header class="header">
            <a href="index.html" class="logo-link">
                <img src="https://assets-global.website-files.com/64959115325a39842503a71b/64959115325a39842503a731_logosiena-1.png" alt="Logo Siena Paris">
            </a>
            <h1>Tableau de Bord Siena</h1>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="overview">Vue d'ensemble</button>
            <!-- NOUVEAU: Onglet Synthèse IA -->
            <button class="nav-tab" data-tab="ai-synthesis">Synthèse IA ✨</button>
            <button class="nav-tab" data-tab="stats-serveurs">Stats Serveurs</button>
            <button class="nav-tab" data-tab="synthese-client">Synthèse Client</button>
            <button class="nav-tab" data-tab="performance">Performance Menu</button>
            <button class="nav-tab" data-tab="feedback">Feedback Interne</button>
            <button class="nav-tab" data-tab="manage">Gestion</button>
            <button class="nav-tab" data-tab="export">Exporter</button>
        </nav>

        <div class="filters" id="global-period-filter" style="display:flex; gap:20px; margin-bottom:20px; align-items: center;">
            <div>
                <label for="global-period-select" style="font-weight: 500;">Période :</label>
                <select id="global-period-select" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border-color);">
                    <option value="all">Tout</option>
                    <option value="30days">30 derniers jours</option>
                    <option value="7days">7 derniers jours</option>
                </select>
            </div>
        </div>

        <main>
            <div id="overview-tab" class="tab-content">
                <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card" style="background-color: var(--surface-color); padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 20px -5px rgba(133, 93, 67, .1);">
                        <h3 id="reviews-period-title" style="font-family: var(--font-sans); font-size: 1rem; color: var(--text-secondary); margin-top: 0; font-weight: 500;">Avis (Total)</h3>
                        <p id="reviews-period-stat" style="font-family: var(--font-serif); font-size: 2.5rem; font-weight: 700; color: var(--brand-color); margin: 10px 0 0;">...</p>
                    </div>
                    <div class="stat-card" style="background-color: var(--surface-color); padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 20px -5px rgba(133, 93, 67, .1);">
                        <h3 id="avg-reviews-title" style="font-family: var(--font-sans); font-size: 1rem; color: var(--text-secondary); margin-top: 0; font-weight: 500;">Moyenne / jour</h3>
                        <p id="avg-reviews-stat" style="font-family: var(--font-serif); font-size: 2.5rem; font-weight: 700; color: var(--brand-color); margin: 10px 0 0;">...</p>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="card card-full">
                        <h2 class="card-title">Tendance des Avis (14 derniers jours)</h2>
                        <div class="chart-container">
                            <canvas id="reviews-trend-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NOUVEAU: Contenu de l'onglet Synthèse IA -->
            <div id="ai-synthesis-tab" class="tab-content hidden">
                <div class="card-header">
                    <h2 class="card-title" style="color: var(--ai-color);">Synthèse par l'Intelligence Artificielle</h2>
                    <button id="generate-synthesis-btn" class="export-btn" style="background-color: var(--ai-color);">Générer la synthèse de la semaine</button>
                </div>
                <div class="dashboard-grid">
                    <div class="card card-full ai-card">
                         <div id="ai-synthesis-content" class="ai-synthesis-content">
                            <p>Cliquez sur le bouton pour générer un résumé des feedbacks de la semaine passée.</p>
                         </div>
                    </div>
                </div>
            </div>

            <div id="stats-serveurs-tab" class="tab-content hidden">
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Classement des Avis</h2>
                        </div>
                        <div style="overflow-x: auto;">
                            <table id="ranking-table">
                                <thead><tr><th>#</th><th>Serveur</th><th style="text-align:right;">Avis</th></tr></thead>
                                <tbody><tr><td colspan="3">Chargement...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="card-title">Top 3 des Serveurs</h2>
                        <div class="chart-container">
                            <canvas id="top3-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="synthese-client-tab" class="tab-content hidden">
                <div class="dashboard-grid">
                    <div class="card">
                        <h2 class="card-title">Qualités de Service les Plus Appréciées</h2>
                        <div class="chart-container">
                            <canvas id="service-qualities-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="card-title">Points Forts de l'Atmosphère</h2>
                        <div class="chart-container">
                            <canvas id="atmosphere-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="performance-tab" class="tab-content hidden">
                 <div class="card card-full">
                    <div class="filters" style="display:flex; gap:20px; margin-bottom:20px; flex-wrap: wrap;">
                        <div>
                            <label for="period-filter">Période :</label>
                            <select id="period-filter" class="period-select-local">
                                <option value="all">Tout</option>
                                <option value="30days">30 derniers jours</option>
                                <option value="7days">7 derniers jours</option>
                            </select>
                        </div>
                        <div>
                            <label for="category-filter">Catégorie :</label>
                            <select id="category-filter"><option value="all">Toutes</option></select>
                        </div>
                    </div>
                    <div class="dashboard-grid">
                        <div class="card">
                            <h2 class="card-title">Top 10 des Plats</h2>
                            <div class="chart-container">
                                <canvas id="top-10-chart"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <h2 class="card-title">Performance par Catégorie</h2>
                            <div class="chart-container">
                                <canvas id="category-pie-chart"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <h2 class="card-title">Les 10 Plats les Moins Populaires</h2>
                            <div id="flops-table-container" style="overflow-x: auto; max-height: 350px;"><p>Chargement...</p></div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Données Complètes</h2>
                            </div>
                            <div id="full-data-table-container" style="overflow-x: auto; max-height: 350px;"><p>Chargement...</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="feedback-tab" class="tab-content hidden">
                <div class="card card-full">
                    <div class="feedback-filters" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                        <div class="nav-tabs" id="feedback-status-tabs" style="margin-bottom: 0; border-bottom: none;">
                            <button class="nav-tab active" data-status="new">Nouveaux</button>
                            <button class="nav-tab" data-status="read">Lus</button>
                            <button class="nav-tab" data-status="archived">Archivés</button>
                        </div>
                        <div class="search-container" style="flex-grow: 1; max-width: 400px;">
                            <input type="search" id="feedback-search-input" placeholder="Rechercher un mot-clé..." style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
                        </div>
                    </div>
                    <div id="feedback-list" class="feedback-list">
                        <p>Chargement des feedbacks...</p>
                    </div>
                </div>
            </div>

            <div id="manage-tab" class="tab-content hidden">
                <div class="dashboard-grid">
                    <div class="card" id="servers-section">
                        <h2 class="card-title">Gérer les Serveurs</h2>
                        <ul id="servers-list" class="item-list"></ul>
                        <form id="add-server-form" class="add-form">
                            <input type="hidden" id="editing-server-id">
                            <input type="text" id="new-server-name" placeholder="Prénom du serveur" required>
                            <!-- NOUVEAU: Champ pour l'URL de l'image -->
                            <input type="url" id="new-server-image-url" placeholder="URL de l'image (optionnel)">
                            <button type="submit">Ajouter Serveur</button>
                        </form>
                    </div>
                    <div class="card" id="flavors-section">
                        <h2 class="card-title">Gérer les Plats (Saveurs)</h2>
                        <ul id="flavors-list" class="item-list"></ul>
                        <form id="add-flavor-form" class="add-form">
                            <input type="hidden" id="editing-flavor-id">
                            <input type="text" id="new-flavor-text" placeholder="Nom du plat" required>
                            <select id="new-flavor-category" required>
                                <option value="" disabled selected>Choisir une catégorie</option>
                                <option value="Antipasti & Crudo">Antipasti & Crudo</option>
                                <option value="Pâtes">Pâtes</option>
                                <option value="Viandes & Poissons">Viandes & Poissons</option>
                                <option value="Pizze">Pizze</option>
                                <option value="Douceurs">Douceurs</option>
                            </select>
                            <button type="submit">Ajouter Plat</button>
                        </form>
                    </div>
                </div>
                <div class="card danger-zone">
                    <h2 class="card-title">Zone de Danger</h2>
                    <p>Cette action réinitialisera toutes les statistiques d'avis et de performance du menu. Les serveurs, plats et feedbacks internes ne seront pas affectés.</p>
                    <button id="reset-data-btn">Réinitialiser les Données Reçues</button>
                </div>
            </div>

            <div id="export-tab" class="tab-content hidden">
                <div class="card card-full">
                    <h2 class="card-title">Exporter les Données</h2>
                    <p>Sélectionnez les données à exporter. Chaque sélection sera téléchargée dans un fichier CSV séparé.</p>
                    
                    <div id="export-options" style="margin: 30px 0; display: flex; flex-direction: column; gap: 20px;">
                        <label class="export-option">
                            <input type="checkbox" id="export-check-ranking" value="ranking">
                            Exporter le classement des serveurs
                        </label>
                        <label class="export-option">
                            <input type="checkbox" id="export-check-performance" value="performance">
                            Exporter la performance complète des plats
                        </label>
                        <label class="export-option">
                            <input type="checkbox" id="export-check-feedback" value="feedback">
                            Exporter tous les feedbacks internes
                        </label>
                    </div>
        
                    <button id="export-selected-btn" class="export-btn">Lancer l'Exportation</button>
                </div>
            </div>

        </main>
    </div>

    <script>
    // ... (Le JS sera mis à jour en conséquence, voir ci-dessous pour les changements clés)
    document.addEventListener('DOMContentLoaded', () => {
        // ... (code existant)
        const API_BASE_URL = 'https://siena-avis.onrender.com';
        let currentPassword = '';
        let charts = { top3: null, top10: null, categoryPie: null, reviewsTrend: null, serviceQualities: null, atmosphere: null };

        // ... (toutes les déclarations de constantes pour les éléments du DOM)
        const generateSynthesisBtn = document.getElementById('generate-synthesis-btn');
        const aiSynthesisContent = document.getElementById('ai-synthesis-content');

        // ... (logique de mot de passe inchangée)

        function loadDataForTab(tabName) {
            // NOUVEAU: Cacher le filtre de période global par défaut, le montrer si nécessaire
            const showGlobalFilter = ['overview', 'stats-serveurs'].includes(tabName);
            globalPeriodFilter.classList.toggle('hidden', !showGlobalFilter);

            switch(tabName) {
                case 'overview': loadOverviewData(); break;
                case 'ai-synthesis': loadAiSynthesisData(); break; // NOUVEAU
                case 'stats-serveurs': loadServerStatsData(); break;
                case 'synthese-client': loadQualitativeSynthesisData(); break;
                case 'performance': loadMenuPerformanceData(); break;
                case 'feedback': loadInternalFeedbackData('new', ''); break;
                case 'manage': loadManagementData(); break;
                case 'export': /* No data to load initially */ break;
            }
        }

        // NOUVEAU: Fonctions pour l'onglet Synthèse IA
        async function loadAiSynthesisData() {
            aiSynthesisContent.innerHTML = '<p>Chargement de la dernière synthèse...</p>';
            try {
                const data = await fetchWithAuth(`${API_BASE_URL}/api/ai-synthesis`);
                if (data.synthesis) {
                    aiSynthesisContent.innerHTML = data.synthesis; // Supposant que le backend renvoie du HTML formaté
                } else {
                    aiSynthesisContent.innerHTML = '<p>Aucune synthèse disponible. Cliquez sur le bouton pour en générer une.</p>';
                }
            } catch (error) {
                console.error("Erreur chargement Synthèse IA:", error);
                aiSynthesisContent.innerHTML = `<p style="color:var(--danger-color)">${error.message}</p>`;
            }
        }

        generateSynthesisBtn.addEventListener('click', async () => {
            generateSynthesisBtn.disabled = true;
            generateSynthesisBtn.textContent = 'Génération en cours...';
            aiSynthesisContent.innerHTML = '<p>L\'IA analyse les données, veuillez patienter...</p>';
            try {
                const data = await fetchWithAuth(`${API_BASE_URL}/api/ai-synthesis`, { method: 'POST' });
                if (data.synthesis) {
                    aiSynthesisContent.innerHTML = data.synthesis;
                } else {
                    throw new Error(data.error || 'La génération a échoué.');
                }
            } catch (error) {
                console.error("Erreur génération Synthèse IA:", error);
                aiSynthesisContent.innerHTML = `<p style="color:var(--danger-color)">${error.message}</p>`;
            } finally {
                generateSynthesisBtn.disabled = false;
                generateSynthesisBtn.textContent = 'Générer la synthèse de la semaine';
            }
        });

        // NOUVEAU: Mise à jour de la gestion des serveurs
        const manage = {
            servers: { 
                list: document.getElementById('servers-list'), 
                form: document.getElementById('add-server-form'), 
                idInput: document.getElementById('editing-server-id'), 
                nameInput: document.getElementById('new-server-name'),
                imageUrlInput: document.getElementById('new-server-image-url'), // NOUVEAU
                btn: document.querySelector('#add-server-form button') 
            },
            // ... (gestion des plats inchangée)
        };

        function populateManageList(listEl, items, type) {
            listEl.innerHTML = items.length === 0 ? '<li>Aucun élément.</li>' : items.map(item => {
                const text = item.name || item.text;
                const category = item.category ? ` <em>(${item.category})</em>` : '';
                // NOUVEAU: Ajout de data-image-url
                return `<li>
                            <span>${text}${category}</span>
                            <div class="item-actions">
                                <button class="action-btn edit-btn" data-id="${item.id}" data-type="${type}" data-name="${item.name || ''}" data-text="${item.text || ''}" data-category="${item.category || ''}" data-image-url="${item.image_url || ''}" title="Éditer">✎</button>
                                <button class="action-btn delete-btn" data-id="${item.id}" data-type="${type}" title="Supprimer">×</button>
                            </div>
                        </li>`;
            }).join('');
        }

        manage.servers.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = manage.servers.idInput.value;
            const name = manage.servers.nameInput.value.trim();
            const image_url = manage.servers.imageUrlInput.value.trim(); // NOUVEAU
            if (!name) return;
            const url = id ? `${API_BASE_URL}/api/servers/${id}` : `${API_BASE_URL}/api/servers`;
            const method = id ? 'PUT' : 'POST';
            await fetchWithAuth(url, { method, body: { name, image_url } }); // NOUVEAU
            resetServerForm();
            loadManagementData();
        });

        // NOUVEAU: Mise à jour du reset form et de l'édition
        function resetServerForm() {
            manage.servers.form.reset();
            manage.servers.idInput.value = '';
            manage.servers.imageUrlInput.value = ''; // NOUVEAU
            manage.servers.btn.textContent = 'Ajouter Serveur';
            manage.servers.btn.classList.remove('edit-mode');
        }

        document.getElementById('manage-tab').addEventListener('click', async (e) => {
            const target = e.target.closest('.action-btn.edit-btn');
            if (!target) return; // Seuls les clics sur le bouton edit sont gérés ici pour la démo

            const { id, type, name, imageUrl } = target.dataset;
            if (type === 'servers') {
                resetFlavorForm();
                manage.servers.idInput.value = id;
                manage.servers.nameInput.value = name;
                manage.servers.imageUrlInput.value = target.dataset.imageUrl; // NOUVEAU
                manage.servers.btn.textContent = 'Enregistrer les modifications';
                manage.servers.btn.classList.add('edit-mode');
                manage.servers.nameInput.focus();
            } // ... (else if pour les plats)
        });

        // ... (le reste du JS existant, avec les adaptations nécessaires pour les nouvelles routes et données)
    });
    </script>
</body>
</html>

<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Siena â€” Votre Avis</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS DÃ©diÃ© (Lien ajoutÃ©) -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="site-header">
            <div class="brand">
                <div class="logo">S</div>
                <div>
                    <h1 data-translate-key="page_title">Siena</h1>
                    <p data-translate-key="brand_subtitle">Ristorante Italiano â€” Ã©lÃ©gance & chaleur</p>
                </div>
            </div>
            <div class="language-switcher">
                <button class="btn lang-btn" data-lang="fr">ðŸ‡«ðŸ‡·</button>
                <button class="btn lang-btn" data-lang="en">ðŸ‡¬ðŸ‡§</button>
                <button class="btn lang-btn" data-lang="es">ðŸ‡ªðŸ‡¸</button>
            </div>
        </header>

        <main class="left-column">
            <section class="card">
                <div class="intro">
                    <h2 data-translate-key="main_title">Une soirÃ©e mÃ©morable ?</h2>
                    <p data-translate-key="subtitle">Votre avis est la touche finale de votre expÃ©rience. Partagez ce qui a enchantÃ© vos sens.</p>
                </div>

                <form id="review-form">
                    <!-- Le contenu du formulaire est injectÃ© ici par JS pour la logique -->
                    <div id="detailed-review-section">
                        <div class="tag-section">
                            <h3 data-translate-key="occasion_title"></h3>
                            <div class="tag-group" data-category="reason_for_visit">
                                <input type="radio" id="event_birthday" name="event" value="un anniversaire"><label for="event_birthday" data-translate-key="occasion_birthday"></label>
                                <input type="radio" id="event_romantic" name="event" value="un dÃ®ner romantique"><label for="event_romantic" data-translate-key="occasion_romantic"></label>
                                <input type="radio" id="event_friends" name="event" value="un dÃ®ner entre amis"><label for="event_friends" data-translate-key="occasion_friends"></label>
                                <input type="radio" id="event_visit" name="event" value="une simple visite" checked><label for="event_visit" data-translate-key="occasion_visit"></label>
                            </div>
                        </div>

                        <div class="tag-section">
                            <h3 data-translate-key="server_title"></h3>
                            <div class="field">
                                <select id="server-select" data-category="server_name">
                                    <option value="" data-translate-key="server_choose"></option>
                                </select>
                            </div>
                            <div id="service-qualities-container" class="hidden">
                                <p class="small-text" data-translate-key="service_subtitle"></p>
                                <p class="limit-notification hidden"></p>
                                <div class="tag-group" data-category="service_qualities">
                                    <input type="checkbox" id="tag_service_1" value="attentionnÃ©"><label for="tag_service_1" data-translate-key="service_q1"></label>
                                    <input type="checkbox" id="tag_service_2" value="souriant et chaleureux"><label for="tag_service_2" data-translate-key="service_q2"></label>
                                    <input type="checkbox" id="tag_service_3" value="professionnel"><label for="tag_service_3" data-translate-key="service_q3"></label>
                                    <input type="checkbox" id="tag_service_4" value="efficace et rapide"><label for="tag_service_4" data-translate-key="service_q4"></label>
                                    <input type="checkbox" id="tag_service_5" value="de trÃ¨s bon conseil"><label for="tag_service_5" data-translate-key="service_q5"></label>
                                    <input type="checkbox" id="tag_service_6" value="discret"><label for="tag_service_6" data-translate-key="service_q6"></label>
                                </div>
                            </div>
                        </div>

                        <div class="tag-section">
                            <h3 data-translate-key="flavors_title"></h3>
                            <p class="small-text" data-translate-key="flavors_subtitle"></p>
                            <p class="limit-notification hidden"></p>
                            <div id="dishes-content" data-category="dish">
                                <p data-translate-key="loading_options">Chargement...</p>
                            </div>
                        </div>

                        <div class="tag-section">
                            <h3 data-translate-key="atmosphere_title"></h3>
                             <p class="small-text" data-translate-key="atmosphere_subtitle"></p>
                            <p class="limit-notification hidden"></p>
                            <div class="tag-group" data-category="atmosphere" id="atmospheres-content"></div>
                        </div>
                    </div>

                    <div class="tag-section">
                        <h3 data-translate-key="private_feedback_label">Suggestion privÃ©e</h3>
                        <div class="field">
                            <textarea id="private-feedback-text" data-translate-key="private_feedback_placeholder" placeholder="Votre suggestion nous aidera Ã  nous amÃ©liorer..."></textarea>
                        </div>
                    </div>

                    <div style="display:flex;justify-content:flex-end;">
                        <button type="submit" id="generate-btn" class="btn btn-primary" data-translate-key="generate_button"></button>
                    </div>
                </form>

                <div id="loader" class="loader-container hidden">
                    <div class="loader"></div>
                    <span id="loader-text"></span>
                </div>

                <div id="result-area" class="hidden">
                    <div id="thank-you-message" class="hidden"></div>
                    <textarea id="review-text" readonly></textarea>
                    <a href="https://search.google.com/local/writereview?placeid=ChIJIdvGkX5v5kcRQ1FTWUnyJxo" target="_blank" id="google-btn" class="btn btn-primary" data-translate-key="publish_button"></a>
                </div>
            </section>
        </main>

        <aside class="right-column">
            <div class="info-card">
                <h3>Offre du jour</h3>
                <p>Menu dÃ©gustation â€” entrÃ©e, plat, dessert. Parfait pour une soirÃ©e Ã©lÃ©gante.</p>
            </div>
            <div class="info-card">
                <h3>Heures de pointe</h3>
                <p>Pour une meilleure expÃ©rience, rÃ©servez en dehors des heures 19:00â€“21:00.</p>
            </div>
        </aside>

        <footer class="site-footer">
            <div>Â© <span id="copyright-year"></span> <strong>Siena</strong></div>
            <div class="muted" data-translate-key="footer_rights">Tous droits rÃ©servÃ©s</div>
        </footer>
    </div>
    <div id="notification" class="hidden"></div>

    <script>
    // TOUT LE JAVASCRIPT DE L'ANCIEN index.html EST INTÃ‰GRÃ‰ ICI
    // Les sÃ©lecteurs et la logique ont Ã©tÃ© adaptÃ©s Ã  la nouvelle structure HTML.
    document.addEventListener('DOMContentLoaded', () => {
        const translations = {
            fr: {
                page_title: "Siena", brand_subtitle: "Ristorante Italiano â€” Ã©lÃ©gance & chaleur",
                main_title: "Une soirÃ©e mÃ©morable ?", subtitle: "Votre avis est la touche finale. Partagez ce qui a enchantÃ© vos sens.", 
                occasion_title: "Une occasion spÃ©ciale ?", occasion_birthday: "Anniversaire", occasion_romantic: "DÃ®ner romantique", occasion_friends: "DÃ®ner entre amis", occasion_visit: "Simple visite",
                server_title: "Quel serveur fÃ©liciter ?", server_choose: "-- Choisissez un prÃ©nom --", service_subtitle: "Qu'avez-vous apprÃ©ciÃ© ? (3 choix max)", service_q1: "AttentionnÃ©", service_q2: "Souriant", service_q3: "Professionnel", service_q4: "Efficace", service_q5: "De bon conseil", service_q6: "Discret", 
                flavors_title: "Les saveurs qui vous ont marquÃ©", flavors_subtitle: "Choisissez jusqu'Ã  6 coups de cÅ“ur.", 
                atmosphere_title: "L'atmosphÃ¨re du lieu", atmosphere_subtitle: "SÃ©lectionnez jusqu'Ã  3 options.",
                atmosphere_decoration: "La DÃ©coration", atmosphere_music: "La Musique", atmosphere_energy: "L'Ã‰nergie Festive", atmosphere_lighting: "L'Ã‰clairage", atmosphere_comfort: "Le Confort", atmosphere_photo: "IdÃ©al pour photos",
                private_feedback_label: "Suggestion privÃ©e pour l'Ã©quipe", private_feedback_placeholder: "Votre suggestion nous aidera Ã  nous amÃ©liorer...",
                generate_button: "CrÃ©er mon message", publish_button: "Publier sur Google", footer_rights: "Tous droits rÃ©servÃ©s.", 
                loading_messages: ["Contact de notre assistant crÃ©atif...","Analyse de votre soirÃ©e...","L'inspiration est en chemin..."], 
                alert_no_option: "Veuillez sÃ©lectionner au moins une option ou laisser un feedback privÃ©.", 
                limit_reached: (limit) => `Vous avez atteint la limite de ${limit} options.`,
                thank_you_title: "Merci pour votre contribution !", thank_you_instructions: "<strong>Suivez ces 2 Ã©tapes :</strong><br>1. Le texte a Ã©tÃ© copiÃ©.<br>2. Cliquez sur 'Publier sur Google' et collez votre avis.",
                loading_options: "Chargement des options...", loading_error: "Erreur de chargement."
            },
            en: {
                page_title: "Siena", brand_subtitle: "Italian Restaurant â€” elegance & warmth",
                main_title: "A memorable evening?", subtitle: "Your feedback is the finishing touch. Share what delighted your senses.", 
                occasion_title: "A special occasion?", occasion_birthday: "Birthday", occasion_romantic: "Romantic dinner", occasion_friends: "Dinner with friends", occasion_visit: "Just visiting",
                server_title: "Which server to praise?", server_choose: "-- Choose a name --", service_subtitle: "What did you appreciate? (3 choices max)", service_q1: "Attentive", service_q2: "Smiling", service_q3: "Professional", service_q4: "Efficient", service_q5: "Great advice", service_q6: "Discreet",
                flavors_title: "The flavors that stood out", flavors_subtitle: "Choose up to 6 of your favorites.",
                atmosphere_title: "The atmosphere", atmosphere_subtitle: "Select up to 3 options.",
                atmosphere_decoration: "Decoration", atmosphere_music: "Music", atmosphere_energy: "Festive Energy", atmosphere_lighting: "Lighting", atmosphere_comfort: "Comfort", atmosphere_photo: "Great for photos",
                private_feedback_label: "Private suggestion for the team", private_feedback_placeholder: "Your suggestion will help us improve...",
                generate_button: "Create my message", publish_button: "Publish on Google", footer_rights: "All rights reserved.",
                loading_messages: ["Contacting our creative assistant...","Analyzing your evening...","Inspiration is on its way..."],
                alert_no_option: "Please select at least one option or leave private feedback.",
                limit_reached: (limit) => `You have reached the limit of ${limit} options.`,
                thank_you_title: "Thank you for your contribution!", thank_you_instructions: "<strong>Follow these 2 steps:</strong><br>1. The text has been copied.<br>2. Click 'Publish on Google' and paste your review.",
                loading_options: "Loading options...", loading_error: "Error loading options."
            },
            es: {
                page_title: "Siena", brand_subtitle: "Restaurante Italiano â€” elegancia y calidez",
                main_title: "Â¿Una noche memorable?", subtitle: "Tu opiniÃ³n es el toque final. Comparte lo que deleitÃ³ tus sentidos.",
                occasion_title: "Â¿Una ocasiÃ³n especial?", occasion_birthday: "CumpleaÃ±os", occasion_romantic: "Cena romÃ¡ntica", occasion_friends: "Cena entre amigos", occasion_visit: "Simple visita",
                server_title: "Â¿A quÃ© camarero felicitar?", server_choose: "-- Elige un nombre --", service_subtitle: "Â¿QuÃ© te gustÃ³? (3 opciones mÃ¡x.)", service_q1: "Atento", service_q2: "Sonriente", service_q3: "Profesional", service_q4: "Eficiente", service_q5: "Buen consejero", service_q6: "Discreto",
                flavors_title: "Los sabores que te marcaron", flavors_subtitle: "Elige hasta 6 de tus favoritos.",
                atmosphere_title: "El ambiente del lugar", atmosphere_subtitle: "Selecciona hasta 3 opciones.",
                atmosphere_decoration: "La DecoraciÃ³n", atmosphere_music: "La MÃºsica", atmosphere_energy: "La EnergÃ­a Festiva", atmosphere_lighting: "La IluminaciÃ³n", atmosphere_comfort: "La Comodidad", atmosphere_photo: "Ideal para fotos",
                private_feedback_label: "Sugerencia privada para el equipo", private_feedback_placeholder: "Tu sugerencia nos ayudarÃ¡ a mejorar...",
                generate_button: "Crear mi mensaje", publish_button: "Publicar en Google", footer_rights: "Todos los derechos reservados.",
                loading_messages: ["Contactando a nuestro asistente...", "Analizando tu noche...", "La inspiraciÃ³n estÃ¡ en camino..."],
                alert_no_option: "Por favor, selecciona al menos una opciÃ³n o deja un comentario privado.",
                limit_reached: (limit) => `Has alcanzado el lÃ­mite de ${limit} opciones.`,
                thank_you_title: "Â¡Gracias por tu contribuciÃ³n!", thank_you_instructions: "<strong>Sigue estos 2 pasos:</strong><br>1. El texto ha sido copiado.<br>2. Haz clic en 'Publicar en Google' y pega tu reseÃ±a.",
                loading_options: "Cargando opciones...", loading_error: "Error al cargar las opciones."
            }
        };
        
        let currentLang = 'fr';
        const form = document.getElementById('review-form');
        const serverSelect = document.getElementById('server-select');
        const serviceQualitiesContainer = document.getElementById('service-qualities-container');
        const googleBtn = document.getElementById('google-btn');
        const reviewText = document.getElementById('review-text');
        const generateBtn = document.getElementById('generate-btn');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const resultArea = document.getElementById('result-area');
        const thankYouMessage = document.getElementById('thank-you-message');
        const notification = document.getElementById('notification');
        const privateFeedbackText = document.getElementById('private-feedback-text');
        let loadingInterval;

        const getTranslation = (key, ...args) => {
            const value = translations[currentLang]?.[key] || translations['fr'][key];
            return typeof value === 'function' ? value(...args) : value;
        };

        const showNotification = (message) => {
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        };

        const translatePage = () => {
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if (el.placeholder) el.placeholder = getTranslation(key);
                else el.innerHTML = getTranslation(key);
            });
        };

        const switchLanguage = (lang) => {
            if (translations[lang]) {
                currentLang = lang;
                document.documentElement.lang = lang;
                document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === lang));
                translatePage();
                fetchPublicData(lang);
            }
        };
        
        const getLimitForCategory = (category) => ({'service_qualities': 3, 'dish': 6, 'atmosphere': 3}[category]);

        const initializeCheckboxGroup = (category) => {
            const limit = getLimitForCategory(category);
            if (!limit) return;
            const container = document.querySelector(`[data-category="${category}"]`);
            if (!container) return;
            const section = container.closest('.tag-section');
            const notificationEl = section.querySelector('.limit-notification');
            
            container.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const checkedCount = container.querySelectorAll('input[type="checkbox"]:checked').length;
                    const limitReached = checkedCount >= limit;
                    container.querySelectorAll('input[type="checkbox"]:not(:checked)').forEach(cb => cb.disabled = limitReached);
                    if (notificationEl) {
                        notificationEl.classList.toggle('hidden', !limitReached);
                        if(limitReached) notificationEl.textContent = getTranslation('limit_reached', limit);
                    }
                }
            });
        };

        const populateAtmospheres = () => {
            const options = [
                { key: 'atmosphere_decoration', value: 'Decoration' }, { key: 'atmosphere_music', value: 'Music' },
                { key: 'atmosphere_energy', value: 'Festive Energy' }, { key: 'atmosphere_lighting', value: 'Lighting' },
                { key: 'atmosphere_comfort', value: 'Comfort' }, { key: 'atmosphere_photo', value: 'Ideal for photos' }
            ];
            const container = document.getElementById('atmospheres-content');
            container.innerHTML = options.map(opt => `<input type="checkbox" id="${opt.key}" value="${opt.value}"><label for="${opt.key}" data-translate-key="${opt.key}"></label>`).join('');
            initializeCheckboxGroup('atmosphere');
        };

        async function fetchPublicData(lang) {
            try {
                const response = await fetch(`https://siena-avis.onrender.com/api/public/data?lang=${lang}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                const currentValue = serverSelect.value;
                serverSelect.innerHTML = `<option value="" data-translate-key="server_choose">${getTranslation('server_choose')}</option>`;
                (data.servers || []).forEach(server => serverSelect.innerHTML += `<option value="${server.name}">${server.name}</option>`);
                serverSelect.value = currentValue;

                const dishesContent = document.getElementById('dishes-content');
                dishesContent.innerHTML = '';
                for (const category in data.flavors || {}) {
                    let subHTML = `<h4 class="small-text" style="font-weight:bold; margin-top:20px;">${category}</h4><div class="tag-group">`;
                    data.flavors[category].forEach(flavor => subHTML += `<input type="checkbox" id="dish_${flavor.id}" value="${flavor.text}"><label for="dish_${flavor.id}">${flavor.text}</label>`);
                    dishesContent.innerHTML += subHTML + `</div>`;
                }
                initializeCheckboxGroup('dish');
            } catch (error) {
                console.error('Failed to fetch public data:', error);
                document.getElementById('dishes-content').innerHTML = `<p>${getTranslation('loading_error')}</p>`;
            }
        }
        
        document.querySelectorAll('.lang-btn').forEach(button => button.addEventListener('click', () => switchLanguage(button.dataset.lang)));

        serverSelect.addEventListener('change', () => {
            serviceQualitiesContainer.classList.toggle('hidden', !serverSelect.value);
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const tags = [];
            document.querySelectorAll('input:checked, select').forEach(el => {
                const container = el.closest('[data-category]');
                if (container && el.value) tags.push({ category: container.dataset.category, value: el.value });
            });
            const privateFeedback = privateFeedbackText.value.trim();

            if (tags.length === 0 && !privateFeedback) {
                showNotification(getTranslation('alert_no_option'));
                return;
            }

            form.classList.add('hidden');
            loader.classList.remove('hidden');
            let msgIndex = 0;
            loaderText.textContent = getTranslation('loading_messages')[msgIndex];
            loadingInterval = setInterval(() => {
                msgIndex = (msgIndex + 1) % getTranslation('loading_messages').length;
                loaderText.textContent = getTranslation('loading_messages')[msgIndex];
            }, 2000);

            try {
                const response = await fetch('https://siena-avis.onrender.com/generate-review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lang: currentLang, tags, private_feedback: privateFeedback })
                });
                const result = await response.json();
                
                clearInterval(loadingInterval);
                loader.classList.add('hidden');

                if (result.error) {
                    showNotification(result.error);
                    form.classList.remove('hidden');
                    return;
                }

                resultArea.classList.remove('hidden');
                if (result.review) {
                    reviewText.value = result.review;
                    reviewText.style.height = (reviewText.scrollHeight) + 'px';
                    thankYouMessage.innerHTML = `<h4>${getTranslation('thank_you_title')}</h4><p>${getTranslation('thank_you_instructions')}</p>`;
                    thankYouMessage.classList.remove('hidden');
                } else {
                    thankYouMessage.innerHTML = `<h4>${getTranslation('thank_you_title')}</h4>`;
                    thankYouMessage.classList.remove('hidden');
                    googleBtn.classList.add('hidden');
                    reviewText.classList.add('hidden');
                }
            } catch (error) {
                clearInterval(loadingInterval);
                loader.classList.add('hidden');
                form.classList.remove('hidden');
                showNotification('Erreur de connexion au serveur.');
            }
        });

        googleBtn.addEventListener('click', () => {
            if (reviewText.value) {
                reviewText.select();
                document.execCommand('copy');
                showNotification('Texte copiÃ© !');
            }
        });

        document.getElementById('copyright-year').textContent = new Date().getFullYear();
        populateAtmospheres();
        initializeCheckboxGroup('service_qualities');
        switchLanguage('fr'); // Init with French
    });
    </script>
</body>
</html>
